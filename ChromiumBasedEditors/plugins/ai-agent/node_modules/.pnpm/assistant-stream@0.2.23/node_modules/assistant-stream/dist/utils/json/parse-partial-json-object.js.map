{"version":3,"sources":["../../../src/utils/json/parse-partial-json-object.ts"],"sourcesContent":["import sjson from \"secure-json-parse\";\nimport { fixJson } from \"./fix-json\";\nimport { ReadonlyJSONObject } from \"./json-value\";\n\nconst PARTIAL_JSON_OBJECT_META_SYMBOL = Symbol(\n  \"aui.parse-partial-json-object.meta\",\n);\n\ntype FieldState = \"complete\" | \"partial\";\n\ntype PartialJsonObjectMeta = {\n  state: \"complete\" | \"partial\";\n  partialPath: string[];\n};\n\nexport const getPartialJsonObjectMeta = (\n  obj: Record<symbol, unknown>,\n): PartialJsonObjectMeta | undefined => {\n  return obj?.[PARTIAL_JSON_OBJECT_META_SYMBOL] as PartialJsonObjectMeta;\n};\n\nexport const parsePartialJsonObject = (\n  json: string,\n):\n  | (ReadonlyJSONObject & {\n      [PARTIAL_JSON_OBJECT_META_SYMBOL]: PartialJsonObjectMeta;\n    })\n  | undefined => {\n  if (json.length === 0)\n    return {\n      [PARTIAL_JSON_OBJECT_META_SYMBOL]: { state: \"partial\", partialPath: [] },\n    };\n\n  try {\n    const res = sjson.parse(json);\n    if (typeof res !== \"object\" || res === null)\n      throw new Error(\"argsText is expected to be an object\");\n\n    res[PARTIAL_JSON_OBJECT_META_SYMBOL] = {\n      state: \"complete\",\n      partialPath: [],\n    };\n    return res;\n  } catch {\n    try {\n      const [fixedJson, partialPath] = fixJson(json);\n      const res = sjson.parse(fixedJson);\n      if (typeof res !== \"object\" || res === null)\n        throw new Error(\"argsText is expected to be an object\");\n\n      res[PARTIAL_JSON_OBJECT_META_SYMBOL] = {\n        state: \"partial\",\n        partialPath,\n      };\n      return res;\n    } catch {\n      return undefined;\n    }\n  }\n};\n\nconst getFieldState = (\n  parent: unknown,\n  parentMeta: PartialJsonObjectMeta,\n  fieldPath: string[],\n): FieldState => {\n  if (typeof parent !== \"object\" || parent === null) return parentMeta.state;\n\n  // 1) parent is complete: return \"complete\"\n  if (parentMeta.state === \"complete\") return \"complete\";\n\n  // 2) we finished traversing: return parent state\n  if (fieldPath.length === 0) return parentMeta.state;\n\n  const [field, ...restPath] = fieldPath as [string, ...string[]];\n\n  // 3) field doesn't yet exist in parent: return \"partial\"\n  if (!Object.prototype.hasOwnProperty.call(parent, field)) return \"partial\";\n\n  const [partialField, ...restPartialPath] = parentMeta.partialPath;\n\n  // 4) field exists but is not partial: return \"complete\"\n  if (field !== partialField) return \"complete\";\n\n  // 5) field exists and is partial: return child state\n  const child = (parent as Record<string, unknown>)[field];\n  const childMeta: PartialJsonObjectMeta = {\n    state: \"partial\",\n    partialPath: restPartialPath,\n  };\n\n  return getFieldState(child, childMeta, restPath);\n};\n\nexport const getPartialJsonObjectFieldState = (\n  obj: Record<string, unknown>,\n  fieldPath: (string | number)[],\n): FieldState => {\n  const meta = getPartialJsonObjectMeta(obj);\n  if (!meta) throw new Error(\"unable to determine object state\");\n\n  return getFieldState(obj, meta, fieldPath.map(String));\n};\n"],"mappings":";AAAA,OAAO,WAAW;AAClB,SAAS,eAAe;AAGxB,IAAM,kCAAkC;AAAA,EACtC;AACF;AASO,IAAM,2BAA2B,CACtC,QACsC;AACtC,SAAO,MAAM,+BAA+B;AAC9C;AAEO,IAAM,yBAAyB,CACpC,SAKe;AACf,MAAI,KAAK,WAAW;AAClB,WAAO;AAAA,MACL,CAAC,+BAA+B,GAAG,EAAE,OAAO,WAAW,aAAa,CAAC,EAAE;AAAA,IACzE;AAEF,MAAI;AACF,UAAM,MAAM,MAAM,MAAM,IAAI;AAC5B,QAAI,OAAO,QAAQ,YAAY,QAAQ;AACrC,YAAM,IAAI,MAAM,sCAAsC;AAExD,QAAI,+BAA+B,IAAI;AAAA,MACrC,OAAO;AAAA,MACP,aAAa,CAAC;AAAA,IAChB;AACA,WAAO;AAAA,EACT,QAAQ;AACN,QAAI;AACF,YAAM,CAAC,WAAW,WAAW,IAAI,QAAQ,IAAI;AAC7C,YAAM,MAAM,MAAM,MAAM,SAAS;AACjC,UAAI,OAAO,QAAQ,YAAY,QAAQ;AACrC,cAAM,IAAI,MAAM,sCAAsC;AAExD,UAAI,+BAA+B,IAAI;AAAA,QACrC,OAAO;AAAA,QACP;AAAA,MACF;AACA,aAAO;AAAA,IACT,QAAQ;AACN,aAAO;AAAA,IACT;AAAA,EACF;AACF;AAEA,IAAM,gBAAgB,CACpB,QACA,YACA,cACe;AACf,MAAI,OAAO,WAAW,YAAY,WAAW,KAAM,QAAO,WAAW;AAGrE,MAAI,WAAW,UAAU,WAAY,QAAO;AAG5C,MAAI,UAAU,WAAW,EAAG,QAAO,WAAW;AAE9C,QAAM,CAAC,OAAO,GAAG,QAAQ,IAAI;AAG7B,MAAI,CAAC,OAAO,UAAU,eAAe,KAAK,QAAQ,KAAK,EAAG,QAAO;AAEjE,QAAM,CAAC,cAAc,GAAG,eAAe,IAAI,WAAW;AAGtD,MAAI,UAAU,aAAc,QAAO;AAGnC,QAAM,QAAS,OAAmC,KAAK;AACvD,QAAM,YAAmC;AAAA,IACvC,OAAO;AAAA,IACP,aAAa;AAAA,EACf;AAEA,SAAO,cAAc,OAAO,WAAW,QAAQ;AACjD;AAEO,IAAM,iCAAiC,CAC5C,KACA,cACe;AACf,QAAM,OAAO,yBAAyB,GAAG;AACzC,MAAI,CAAC,KAAM,OAAM,IAAI,MAAM,kCAAkC;AAE7D,SAAO,cAAc,KAAK,MAAM,UAAU,IAAI,MAAM,CAAC;AACvD;","names":[]}