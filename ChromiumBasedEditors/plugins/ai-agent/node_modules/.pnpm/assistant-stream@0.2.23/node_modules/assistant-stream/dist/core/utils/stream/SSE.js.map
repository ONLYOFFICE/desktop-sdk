{"version":3,"sources":["../../../../src/core/utils/stream/SSE.ts"],"sourcesContent":["import { PipeableTransformStream } from \"./PipeableTransformStream\";\nimport { LineDecoderStream } from \"./LineDecoderStream\";\n\nexport class SSEEncoder<T> extends PipeableTransformStream<\n  T,\n  Uint8Array<ArrayBuffer>\n> {\n  static readonly headers = new Headers({\n    \"Content-Type\": \"text/event-stream\",\n    \"Cache-Control\": \"no-cache\",\n    Connection: \"keep-alive\",\n  });\n\n  headers = SSEEncoder.headers;\n\n  constructor() {\n    super((readable) =>\n      readable\n        .pipeThrough(\n          new TransformStream<T, string>({\n            transform(chunk, controller) {\n              controller.enqueue(`data: ${JSON.stringify(chunk)}\\n\\n`);\n            },\n          }),\n        )\n        .pipeThrough(new TextEncoderStream()),\n    );\n  }\n}\n\ntype SSEEvent = {\n  event: string;\n  data: string;\n  id?: string | undefined;\n  retry?: number | undefined;\n};\n\nclass SSEEventStream extends TransformStream<string, SSEEvent> {\n  constructor() {\n    let eventBuffer: Partial<SSEEvent> = {};\n    let dataLines: string[] = [];\n\n    super({\n      start() {\n        eventBuffer = {};\n        dataLines = [];\n      },\n      transform(line, controller) {\n        if (line.startsWith(\":\")) return; // Ignore comments\n\n        if (line === \"\") {\n          if (dataLines.length > 0) {\n            controller.enqueue({\n              event: eventBuffer.event || \"message\",\n              data: dataLines.join(\"\\n\"),\n              id: eventBuffer.id,\n              retry: eventBuffer.retry,\n            });\n          }\n          eventBuffer = {};\n          dataLines = [];\n          return;\n        }\n\n        const [field, ...rest] = line.split(\":\");\n        const value = rest.join(\":\").trimStart();\n\n        switch (field) {\n          case \"event\":\n            eventBuffer.event = value;\n            break;\n          case \"data\":\n            dataLines.push(value);\n            break;\n          case \"id\":\n            eventBuffer.id = value;\n            break;\n          case \"retry\":\n            eventBuffer.retry = Number(value);\n            break;\n        }\n      },\n      flush(controller) {\n        if (dataLines.length > 0) {\n          controller.enqueue({\n            event: eventBuffer.event || \"message\",\n            data: dataLines.join(\"\\n\"),\n            id: eventBuffer.id,\n            retry: eventBuffer.retry,\n          });\n        }\n      },\n    });\n  }\n}\n\nexport class SSEDecoder<T> extends PipeableTransformStream<\n  Uint8Array<ArrayBuffer>,\n  T\n> {\n  constructor() {\n    super((readable) =>\n      readable\n        .pipeThrough(new TextDecoderStream())\n        .pipeThrough(new LineDecoderStream())\n        .pipeThrough(new SSEEventStream())\n        .pipeThrough(\n          new TransformStream<SSEEvent, T>({\n            transform(event, controller) {\n              switch (event.event) {\n                case \"message\":\n                  controller.enqueue(JSON.parse(event.data));\n                  break;\n                default:\n                  throw new Error(`Unknown SSE event type: ${event.event}`);\n              }\n            },\n          }),\n        ),\n    );\n  }\n}\n"],"mappings":";AAAA,SAAS,+BAA+B;AACxC,SAAS,yBAAyB;AAE3B,IAAM,aAAN,MAAM,oBAAsB,wBAGjC;AAAA,EACA,OAAgB,UAAU,IAAI,QAAQ;AAAA,IACpC,gBAAgB;AAAA,IAChB,iBAAiB;AAAA,IACjB,YAAY;AAAA,EACd,CAAC;AAAA,EAED,UAAU,YAAW;AAAA,EAErB,cAAc;AACZ;AAAA,MAAM,CAAC,aACL,SACG;AAAA,QACC,IAAI,gBAA2B;AAAA,UAC7B,UAAU,OAAO,YAAY;AAC3B,uBAAW,QAAQ,SAAS,KAAK,UAAU,KAAK,CAAC;AAAA;AAAA,CAAM;AAAA,UACzD;AAAA,QACF,CAAC;AAAA,MACH,EACC,YAAY,IAAI,kBAAkB,CAAC;AAAA,IACxC;AAAA,EACF;AACF;AASA,IAAM,iBAAN,cAA6B,gBAAkC;AAAA,EAC7D,cAAc;AACZ,QAAI,cAAiC,CAAC;AACtC,QAAI,YAAsB,CAAC;AAE3B,UAAM;AAAA,MACJ,QAAQ;AACN,sBAAc,CAAC;AACf,oBAAY,CAAC;AAAA,MACf;AAAA,MACA,UAAU,MAAM,YAAY;AAC1B,YAAI,KAAK,WAAW,GAAG,EAAG;AAE1B,YAAI,SAAS,IAAI;AACf,cAAI,UAAU,SAAS,GAAG;AACxB,uBAAW,QAAQ;AAAA,cACjB,OAAO,YAAY,SAAS;AAAA,cAC5B,MAAM,UAAU,KAAK,IAAI;AAAA,cACzB,IAAI,YAAY;AAAA,cAChB,OAAO,YAAY;AAAA,YACrB,CAAC;AAAA,UACH;AACA,wBAAc,CAAC;AACf,sBAAY,CAAC;AACb;AAAA,QACF;AAEA,cAAM,CAAC,OAAO,GAAG,IAAI,IAAI,KAAK,MAAM,GAAG;AACvC,cAAM,QAAQ,KAAK,KAAK,GAAG,EAAE,UAAU;AAEvC,gBAAQ,OAAO;AAAA,UACb,KAAK;AACH,wBAAY,QAAQ;AACpB;AAAA,UACF,KAAK;AACH,sBAAU,KAAK,KAAK;AACpB;AAAA,UACF,KAAK;AACH,wBAAY,KAAK;AACjB;AAAA,UACF,KAAK;AACH,wBAAY,QAAQ,OAAO,KAAK;AAChC;AAAA,QACJ;AAAA,MACF;AAAA,MACA,MAAM,YAAY;AAChB,YAAI,UAAU,SAAS,GAAG;AACxB,qBAAW,QAAQ;AAAA,YACjB,OAAO,YAAY,SAAS;AAAA,YAC5B,MAAM,UAAU,KAAK,IAAI;AAAA,YACzB,IAAI,YAAY;AAAA,YAChB,OAAO,YAAY;AAAA,UACrB,CAAC;AAAA,QACH;AAAA,MACF;AAAA,IACF,CAAC;AAAA,EACH;AACF;AAEO,IAAM,aAAN,cAA4B,wBAGjC;AAAA,EACA,cAAc;AACZ;AAAA,MAAM,CAAC,aACL,SACG,YAAY,IAAI,kBAAkB,CAAC,EACnC,YAAY,IAAI,kBAAkB,CAAC,EACnC,YAAY,IAAI,eAAe,CAAC,EAChC;AAAA,QACC,IAAI,gBAA6B;AAAA,UAC/B,UAAU,OAAO,YAAY;AAC3B,oBAAQ,MAAM,OAAO;AAAA,cACnB,KAAK;AACH,2BAAW,QAAQ,KAAK,MAAM,MAAM,IAAI,CAAC;AACzC;AAAA,cACF;AACE,sBAAM,IAAI,MAAM,2BAA2B,MAAM,KAAK,EAAE;AAAA,YAC5D;AAAA,UACF;AAAA,QACF,CAAC;AAAA,MACH;AAAA,IACJ;AAAA,EACF;AACF;","names":[]}