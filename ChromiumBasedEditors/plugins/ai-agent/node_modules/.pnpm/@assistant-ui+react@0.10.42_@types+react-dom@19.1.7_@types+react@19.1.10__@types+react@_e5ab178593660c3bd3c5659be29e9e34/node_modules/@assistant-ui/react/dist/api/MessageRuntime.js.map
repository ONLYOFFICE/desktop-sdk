{"version":3,"sources":["../../src/api/MessageRuntime.ts"],"sourcesContent":["import {\n  SpeechState,\n  SubmittedFeedback,\n} from \"../runtimes/core/ThreadRuntimeCore\";\nimport { symbolInnerMessage } from \"../runtimes/external-store/getExternalStoreMessage\";\nimport {\n  ThreadMessage,\n  ThreadAssistantMessagePart,\n  ThreadUserMessagePart,\n  Unsubscribe,\n} from \"../types\";\nimport {\n  MessagePartStatus,\n  RunConfig,\n  ToolCallMessagePartStatus,\n} from \"../types/AssistantTypes\";\nimport { getThreadMessageText } from \"../utils/getThreadMessageText\";\nimport {\n  AttachmentRuntime,\n  AttachmentState,\n  MessageAttachmentRuntimeImpl,\n} from \"./AttachmentRuntime\";\nimport {\n  EditComposerRuntime,\n  EditComposerRuntimeImpl,\n} from \"./ComposerRuntime\";\nimport {\n  MessagePartRuntime,\n  MessagePartRuntimeImpl,\n  MessagePartState,\n} from \"./MessagePartRuntime\";\nimport { MessageRuntimePath } from \"./RuntimePathTypes\";\nimport { ThreadRuntimeCoreBinding } from \"./ThreadRuntime\";\nimport { NestedSubscriptionSubject } from \"./subscribable/NestedSubscriptionSubject\";\nimport { SKIP_UPDATE } from \"./subscribable/SKIP_UPDATE\";\nimport { ShallowMemoizeSubject } from \"./subscribable/ShallowMemoizeSubject\";\nimport type { MessageStateBinding } from \"./RuntimeBindings\";\n\nconst COMPLETE_STATUS: MessagePartStatus = Object.freeze({\n  type: \"complete\",\n});\n\nexport const toMessagePartStatus = (\n  message: ThreadMessage,\n  partIndex: number,\n  part: ThreadUserMessagePart | ThreadAssistantMessagePart,\n): ToolCallMessagePartStatus => {\n  if (message.role !== \"assistant\") return COMPLETE_STATUS;\n\n  if (part.type === \"tool-call\") {\n    if (!part.result) {\n      return message.status as ToolCallMessagePartStatus;\n    } else {\n      return COMPLETE_STATUS;\n    }\n  }\n\n  const isLastPart = partIndex === Math.max(0, message.content.length - 1);\n  if (message.status.type === \"requires-action\") return COMPLETE_STATUS;\n  return isLastPart ? (message.status as MessagePartStatus) : COMPLETE_STATUS;\n};\n\nconst getMessagePartState = (\n  message: MessageState,\n  partIndex: number,\n): MessagePartState | SKIP_UPDATE => {\n  const part = message.content[partIndex];\n  if (!part) {\n    return SKIP_UPDATE;\n  }\n\n  // if the message part is the same, don't update\n  const status = toMessagePartStatus(message, partIndex, part);\n  return Object.freeze({\n    ...part,\n    ...{ [symbolInnerMessage]: (part as any)[symbolInnerMessage] },\n    status,\n  });\n};\n\nexport type MessageState = ThreadMessage & {\n  readonly parentId: string | null;\n  readonly isLast: boolean;\n\n  readonly branchNumber: number;\n  readonly branchCount: number;\n\n  /**\n   * @deprecated This API is still under active development and might change without notice.\n   */\n  readonly speech: SpeechState | undefined;\n  readonly submittedFeedback: SubmittedFeedback | undefined;\n};\n\nexport type { MessageStateBinding } from \"./RuntimeBindings\";\n\ntype ReloadConfig = {\n  runConfig?: RunConfig;\n};\n\nexport type MessageRuntime = {\n  readonly path: MessageRuntimePath;\n\n  readonly composer: EditComposerRuntime;\n\n  getState(): MessageState;\n  reload(config?: ReloadConfig): void;\n  /**\n   * @deprecated This API is still under active development and might change without notice.\n   */\n  speak(): void;\n  /**\n   * @deprecated This API is still under active development and might change without notice.\n   */\n  stopSpeaking(): void;\n  submitFeedback({ type }: { type: \"positive\" | \"negative\" }): void;\n  switchToBranch({\n    position,\n    branchId,\n  }: {\n    position?: \"previous\" | \"next\" | undefined;\n    branchId?: string | undefined;\n  }): void;\n  unstable_getCopyText(): string;\n\n  subscribe(callback: () => void): Unsubscribe;\n\n  getMessagePartByIndex(idx: number): MessagePartRuntime;\n  getMessagePartByToolCallId(toolCallId: string): MessagePartRuntime;\n\n  getAttachmentByIndex(idx: number): AttachmentRuntime & { source: \"message\" };\n};\n\nexport class MessageRuntimeImpl implements MessageRuntime {\n  public get path() {\n    return this._core.path;\n  }\n\n  constructor(\n    private _core: MessageStateBinding,\n    private _threadBinding: ThreadRuntimeCoreBinding,\n  ) {\n    this.composer = new EditComposerRuntimeImpl(\n      new NestedSubscriptionSubject({\n        path: {\n          ...this.path,\n          ref: this.path.ref + `${this.path.ref}.composer`,\n          composerSource: \"edit\",\n        },\n        getState: this._getEditComposerRuntimeCore,\n        subscribe: (callback) => this._threadBinding.subscribe(callback),\n      }),\n      () => this._threadBinding.getState().beginEdit(this._core.getState().id),\n    );\n  }\n\n  protected __internal_bindMethods() {\n    this.reload = this.reload.bind(this);\n    this.getState = this.getState.bind(this);\n    this.subscribe = this.subscribe.bind(this);\n    this.getMessagePartByIndex = this.getMessagePartByIndex.bind(this);\n    this.getMessagePartByToolCallId =\n      this.getMessagePartByToolCallId.bind(this);\n    this.getAttachmentByIndex = this.getAttachmentByIndex.bind(this);\n    this.unstable_getCopyText = this.unstable_getCopyText.bind(this);\n    this.speak = this.speak.bind(this);\n    this.stopSpeaking = this.stopSpeaking.bind(this);\n    this.submitFeedback = this.submitFeedback.bind(this);\n    this.switchToBranch = this.switchToBranch.bind(this);\n  }\n\n  public readonly composer;\n\n  private _getEditComposerRuntimeCore = () => {\n    return this._threadBinding\n      .getState()\n      .getEditComposer(this._core.getState().id);\n  };\n\n  public getState() {\n    return this._core.getState();\n  }\n\n  public reload(reloadConfig: ReloadConfig = {}) {\n    const editComposerRuntimeCore = this._getEditComposerRuntimeCore();\n    const composerRuntimeCore =\n      editComposerRuntimeCore ?? this._threadBinding.getState().composer;\n    const composer = editComposerRuntimeCore ?? composerRuntimeCore;\n\n    const { runConfig = composer.runConfig } = reloadConfig;\n    const state = this._core.getState();\n    if (state.role !== \"assistant\")\n      throw new Error(\"Can only reload assistant messages\");\n\n    this._threadBinding.getState().startRun({\n      parentId: state.parentId,\n      sourceId: state.id,\n      runConfig,\n    });\n  }\n\n  public speak() {\n    const state = this._core.getState();\n    return this._threadBinding.getState().speak(state.id);\n  }\n\n  public stopSpeaking() {\n    const state = this._core.getState();\n    const thread = this._threadBinding.getState();\n    if (thread.speech?.messageId === state.id) {\n      this._threadBinding.getState().stopSpeaking();\n    } else {\n      throw new Error(\"Message is not being spoken\");\n    }\n  }\n\n  public submitFeedback({ type }: { type: \"positive\" | \"negative\" }) {\n    const state = this._core.getState();\n    this._threadBinding.getState().submitFeedback({\n      messageId: state.id,\n      type,\n    });\n  }\n\n  public switchToBranch({\n    position,\n    branchId,\n  }: {\n    position?: \"previous\" | \"next\" | undefined;\n    branchId?: string | undefined;\n  }) {\n    const state = this._core.getState();\n    if (branchId && position) {\n      throw new Error(\"May not specify both branchId and position\");\n    } else if (!branchId && !position) {\n      throw new Error(\"Must specify either branchId or position\");\n    }\n\n    const thread = this._threadBinding.getState();\n    const branches = thread.getBranches(state.id);\n    let targetBranch = branchId;\n    if (position === \"previous\") {\n      targetBranch = branches[state.branchNumber - 2];\n    } else if (position === \"next\") {\n      targetBranch = branches[state.branchNumber];\n    }\n    if (!targetBranch) throw new Error(\"Branch not found\");\n\n    this._threadBinding.getState().switchToBranch(targetBranch);\n  }\n\n  public unstable_getCopyText() {\n    return getThreadMessageText(this.getState());\n  }\n\n  public subscribe(callback: () => void) {\n    return this._core.subscribe(callback);\n  }\n\n  public getMessagePartByIndex(idx: number) {\n    if (idx < 0) throw new Error(\"Message part index must be >= 0\");\n    return new MessagePartRuntimeImpl(\n      new ShallowMemoizeSubject({\n        path: {\n          ...this.path,\n          ref: this.path.ref + `${this.path.ref}.content[${idx}]`,\n          messagePartSelector: { type: \"index\", index: idx },\n        },\n        getState: () => {\n          return getMessagePartState(this.getState(), idx);\n        },\n        subscribe: (callback) => this._core.subscribe(callback),\n      }),\n      this._core,\n      this._threadBinding,\n    );\n  }\n\n  public getMessagePartByToolCallId(toolCallId: string) {\n    return new MessagePartRuntimeImpl(\n      new ShallowMemoizeSubject({\n        path: {\n          ...this.path,\n          ref:\n            this.path.ref +\n            `${this.path.ref}.content[toolCallId=${JSON.stringify(toolCallId)}]`,\n          messagePartSelector: { type: \"toolCallId\", toolCallId },\n        },\n        getState: () => {\n          const state = this._core.getState();\n          const idx = state.content.findIndex(\n            (part) =>\n              part.type === \"tool-call\" && part.toolCallId === toolCallId,\n          );\n          if (idx === -1) return SKIP_UPDATE;\n          return getMessagePartState(state, idx);\n        },\n        subscribe: (callback) => this._core.subscribe(callback),\n      }),\n      this._core,\n      this._threadBinding,\n    );\n  }\n\n  public getAttachmentByIndex(idx: number) {\n    return new MessageAttachmentRuntimeImpl(\n      new ShallowMemoizeSubject({\n        path: {\n          ...this.path,\n          ref: this.path.ref + `${this.path.ref}.attachments[${idx}]`,\n          attachmentSource: \"message\",\n          attachmentSelector: { type: \"index\", index: idx },\n        },\n        getState: () => {\n          const attachments = this.getState().attachments;\n          const attachment = attachments?.[idx];\n          if (!attachment) return SKIP_UPDATE;\n\n          return {\n            ...attachment,\n            source: \"message\",\n          } satisfies AttachmentState & { source: \"message\" };\n        },\n        subscribe: (callback) => this._core.subscribe(callback),\n      }),\n    );\n  }\n}\n"],"mappings":"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","names":[]}